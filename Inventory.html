<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory - Product Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
   <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <link rel="stylesheet" href="./header.css">
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
    }

    .header {
      background-color: #F44E68;
      color: white;
      padding: 30px 20px;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .btn-custom {
      background-color: #6f42c1;
      color: white;
      font-weight: 500;
      border-radius: 8px;
      transition: background-color 0.3s ease-in-out;
    }

    .btn-custom:hover {
      background-color: #5932a1;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-sell {
      background-color: #28a745;
      color: white;
    }

    .btn-sell:hover {
      background-color: #218838;
    }

    table {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
    }

    .table th {
      background-color: #e9ecef;
      color: #495057;
    }

    .table td, .table th {
      vertical-align: middle;
    }

    .card-style {
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .total-summary {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: 600;
      border-left: 5px solid #6f42c1;
    }

    .total-summary p {
      margin: 0;
    }

    .total-summary strong {
      color: #6f42c1;
    }

    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      .action-buttons {
        flex-direction: column;
      }
    }
    .inventory-header {
  height: 250px;
  background-size: cover;
  background-position: center;
  color: white;
  text-shadow: 1px 1px 3px #000;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 4px solid #f44e68;
}


  </style>
</head>
<body>
   
     
   <nav class="sidebar">
  <h2>My Dashboard</h2>
  <a href="./dashboard.html" class="active"><i class="fas fa-home"></i> Home</a>
  <a href="./contact.html"><i class="fas fa-user"></i> Profile</a>
  <a href="./product.html"><i class="fas fa-box"></i> Add Product</a>
  <a href="./enter.html"><i class="fas fa-file-invoice"></i> View Bills</a>
  <a href="./grap.html"><i class="fas fa-chart-bar"></i> Reports</a>
  <a href="./denter.html"><i class="fas fa-clone"></i> Duplicate Bills</a>
</nav>
 <main class="main-content">

 <header class="navbar">
    <h1>Welcome Back!</h1>
    <div>
      <i class="bi bi-person-circle user-icon" id="userIcon" title="User Profile"></i>
    </div>

    <div class="user-profile-popup" id="userProfilePopup" aria-hidden="true">
      <h5>User Profile</h5>
      <ul>
        <li><i class="bi bi-telephone-fill"></i> +91 93479 89882</li>
        <li><i class="bi bi-envelope-fill"></i> nagir1090@gmail.com</li>
        <li><i class="bi bi-geo-alt-fill"></i> Kanakadri Palli (V), Kolimigundal (M), Kurnool (Dist) - 518123</li>
      </ul>
    </div>
  </header>

  <div class="container mt-3">
    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="back()">← Back</button>
      <button class="btn btn-custom" onclick="addProduct()">Add Product</button>
      <!-- <button class="btn btn-custom" onclick="updateQuantity()">Update Quantity</button> -->
       <button class="btn btn-warning" onclick="updateProduct()">Update Product</button>

      <button class="btn btn-danger" onclick="removeProduct()">Remove Product</button>
    </div>

    <div class="filter-section">
      <label for="startDate" class="form-label">From Date:</label>
      <input type="date" class="form-control d-inline-block w-auto" id="startDate" />
      <label for="endDate" class="form-label ms-3">To Date:</label>
      <input type="date" class="form-control d-inline-block w-auto" id="endDate" />
      <button class="btn btn-primary mx-2" onclick="filterByDate()">Filter</button>
      <button class="btn btn-success mx-2" onclick="exportToExcel()">Export to Excel</button>
      <button class="btn btn-info mx-2" onclick="exportToWord()">Export to Word</button>
    </div>
<!-- Edit Modal -->


    <div class="card-style mt-3">
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>Product Name</th>
              <th>Model No</th>
              <th>S.No</th>
              <th>Price (₹)</th>
              <th>Quantity</th>
              <th>Date Added</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>
    </div>
  </div>

 </main>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  function back() {
    window.location.href = "model.html";
  }
  

  const modelId = localStorage.getItem("model_id");
  const model = localStorage.getItem("model");
  const productId = localStorage.getItem("product_id");
  const productname =localStorage.getItem("name");
// alert(productname);
  // let productName = "Unnamed Product";
  // let products = []; // Declare globally

  if (!modelId) {
    alert("❌ No model selected. Redirecting...");
    window.location.href = "model.html";
  }

  // alert(productId);
  // alert(model);
  // alert(modelId);
// document.getElementById("productTitle").textContent = model || "Unnamed Model";
   
  async function fetchProducts() {
    try {
      const response = await fetch("http://localhost:3000/api/sno");
      const data = await response.json();
      localStorage.setItem("snumber", JSON.stringify(data));
      return data;
    } catch (err) {
      console.warn("Using cached products due to error:", err);
      const cached = localStorage.getItem("snumber");
      return cached ? JSON.parse(cached) : [];
    }
  }

 let products = [];
let currentSno = null; // Store the sno being edited

async function fetchProducts() {
  const res = await fetch('http://localhost:3000/api/sno');
  return res.json();
}

async function displayProducts() {
  const table = document.getElementById("productList");
  table.innerHTML = "";

  products = await fetchProducts();
  products = products.filter(p => p.model_id == modelId);

  products.forEach((product, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${product.product_name}</td>
      <td>${model}</td>
      <td>${product.serial_number}</td>
      <td>₹${parseFloat(product.price).toFixed(2)}</td>
      <td>${product.quantity}</td>
      <td>${new Date(product.added_date).toLocaleDateString()}</td>
     <td>
 
  <button class="btn btn-sell btn-sm" onclick="sellProductBySno('${product.serial_number}')">Sell</button>
</td>

    `;
    table.appendChild(row);
  });
}
 

  async function addProduct() {
    const sno = prompt("Enter Serial Number:");
    const quantity = parseInt(prompt("Enter Quantity:"), 10);
    const price = parseFloat(prompt("Enter Price (₹):"));
    const addedDate = new Date().toISOString();

    if (!sno || isNaN(quantity) || isNaN(price) ) {
      alert("❌ Missing required fields. Make sure all inputs are valid.");
      return;
    }

    const existing = products.some(p => p.serial_number.toLowerCase() === sno.toLowerCase());
    if (existing) {
      alert("❌ Serial Number already exists for this model.");
      return;
    }

    const payload = {
      serial_number: sno.trim(),
      model_id: parseInt(modelId),
      product_name: productname,
      quantity,
      price,
      added_date: addedDate
    };

    console.log("Sending payload:", payload);

    try {
      const res = await fetch("http://localhost:3000/api/sno", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      console.log("Response:", result);

      if (res.ok) {
        alert("✅ Product added!");
        displayProducts();
      } else {
        alert(`❌ Error: ${result.error || "Unknown error"}`);
      }
    } catch (err) {
      console.error("❌ Fetch error:", err);
      alert("❌ Failed to add product.");
    }
  }

async function removeProduct() {
  const sno = prompt("Enter Serial Number to remove:");

  if (!sno) {
    alert("❌ No serial number entered.");
    return;
  }

  const product = products.find(p => p.serial_number === sno);

  if (!product) {
    alert("❌ Product not found.");
    return;
  }

  const confirmed = confirm(`Are you sure you want to delete product with S.No: ${sno}?`);
  if (!confirmed) return;

  try {
    const res = await fetch(`http://localhost:3000/api/sno/${product.id}`, {
      method: "DELETE",
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert(`❌ Failed to delete: ${err.error || res.statusText}`);
      return;
    }

    // Remove from local array
    products = products.filter(p => p.id !== product.id);
    displayProducts();
    alert("✅ Product deleted successfully.");
  } catch (error) {
    console.error("❌ Error deleting product:", error);
    alert("❌ Failed to delete product.");
  }
}

async function updateProduct() {
  const sno = prompt("Enter Serial Number to update:");

  if (!sno) {
    alert("❌ Serial number is required.");
    return;
  }

  const product = products.find(p => p.serial_number === sno);

  if (!product) {
    alert("❌ Product not found.");
    return;
  }

  const newPrice = parseFloat(prompt("Enter new price:", product.price));
  const newQty = parseInt(prompt("Enter new quantity:", product.quantity));

  if (isNaN(newPrice) || isNaN(newQty)) {
    alert("❌ Invalid input for price or quantity.");
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/api/sno/${product.id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ price: newPrice, quantity: newQty }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert(`❌ Update failed: ${err.error || res.statusText}`);
      return;
    }

    alert("✅ Product updated successfully.");
    displayProducts(); // Reload table
  } catch (error) {
    console.error("❌ Error during update:", error);
    alert("❌ Could not update product.");
  }
}

  function exportToExcel() {
    const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, "Inventory.xlsx");
  }

  function exportToWord() {
    let html = '<html><head><title>Inventory</title></head><body>';
    html += '<h2>Product Inventory</h2><table border="1"><tr><th>Name</th><th>Model</th><th>S.No</th><th>Price</th><th>Qty</th><th>Date</th></tr>';
    products.forEach(p => {
      html += `<tr>
        <td>${p.product_name}</td>
        <td>${p.model || model}</td>
        <td>${p.serial_number}</td>
        <td>₹${p.price}</td>
        <td>${p.quantity}</td>
        <td>${new Date(p.added_date).toLocaleDateString()}</td>
      </tr>`;
    });
    html += '</table></body></html>';

    const blob = new Blob([html], { type: 'application/msword' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Inventory.doc";
    link.click();
  }

//   function editItem(id,price,Qty) {
//     alert(id);
//     al
//    localStorage.setItem('id',id);
//    localStorage.setItem('')
   
// window.location.href = 'edit.html';            // or the correct page path

//   }

  function sellProduct(index) {
    localStorage.setItem("sellIndex", index);
    window.location.href = "sell.html";
  }

  function filterByDate() {
    const from = new Date(document.getElementById("startDate").value);
    const to = new Date(document.getElementById("endDate").value);

    if (isNaN(from) || isNaN(to)) {
      alert("❌ Please enter valid dates.");
      return;
    }

    const filtered = products.filter(p => {
      const added = new Date(p.added_date);
      return added >= from && added <= to;
    });

    const table = document.getElementById("productList");
    table.innerHTML = "";

    filtered.forEach((product, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${product.product_name}</td>
        <td>${product.model || model}</td>
        <td>${product.serial_number}</td>
        <td>₹${product.price}</td>
        <td>${product.quantity}</td>
        <td>${new Date(product.added_date).toLocaleDateString()}</td>
        <td><button class="btn btn-sm btn-warning" onclick="editItem(${index})">Edit</button></td>
      `;
      table.appendChild(row);
    });
  }
  displayProducts();



   // profile
    const userIcon = document.getElementById('userIcon');
    const userProfilePopup = document.getElementById('userProfilePopup');

    userIcon.addEventListener('click', () => {
      const isVisible = userProfilePopup.style.display === 'block';
      userProfilePopup.style.display = isVisible ? 'none' : 'block';
      userProfilePopup.setAttribute('aria-hidden', isVisible);
    });

    // Close popup if clicking outside
    document.addEventListener('click', (event) => {
      if (!userIcon.contains(event.target) && !userProfilePopup.contains(event.target)) {
        userProfilePopup.style.display = 'none';
        userProfilePopup.setAttribute('aria-hidden', 'true');
      }
    });

</script>

</body>
</html>
